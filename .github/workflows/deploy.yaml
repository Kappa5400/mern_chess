name: Master Deployment Pipeline
on:
  push:
    branches: [master]

jobs:
  backend-ci:
    uses: ./.github/workflows/backend-ci.yaml
    secrets: inherit

  frontend-ci:
    uses: ./.github/workflows/frontend-ci.yaml
    secrets: inherit

  deploy:
    needs: [backend-ci, frontend-ci]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # STEP 1: PRE-CLEANUP
      # This deletes the "fake" directories Docker creates when files are missing
      - name: Pre-deployment Cleanup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Only remove the specific files to clear Docker's "fake" directories
            rm -rf ~/mern_chess/nginx/nginx.conf ~/mern_chess/nginx/prod.conf
            mkdir -p ~/mern_chess/nginx

      # STEP 2: TRANSFER ACTUAL FILES
      # This sends your real configuration files to the server
      - name: Copy deployment files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yaml,nginx/, chess/src/"
          target: "~/mern_chess"
          strip_components: 0

      # STEP 3: CONFIGURE AND START
      - name: SSH and Deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/mern_chess

            # Create the production .env file
            cat <<EOF > .env
            DB_URL=${{ secrets.MONGO_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            CLIENT_URL=http://${{ secrets.DROPLET_IP }}
            PORT=5000
            EOF

            # Deploy containers
            docker compose pull
            docker compose up -d --remove-orphans

            # Wait for Nginx to attempt startup
            sleep 10

            # FINAL CHECK: Only reload if Nginx is actually running
            CONTAINER="mern_nginx" 
            if [ "$(docker inspect -f '{{.State.Running}}' $CONTAINER 2>/dev/null)" = "true" ]; then
              docker exec $CONTAINER nginx -t && docker exec $CONTAINER nginx -s reload
            else
              echo "Deployment failed. Nginx is not running."
              docker logs $CONTAINER || docker ps -a
              exit 1
            fi
